<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Database null field error · Doradilla</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='Description for doradilla library.'/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/warnOldVersion.js"></script>
<script type="text/javascript" src="../js/groups.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="../css/page.css"/>

<!--
<link rel="shortcut icon" href="../images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>Doradilla
</a>
<div class="version-number">
0.1.0
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../singletruthprinciple.html" class="page">Single truth principle</a></li>
  <li><a href="../database/index.html" class="page">Database Single truth principle</a>
  <ul>
    <li><a href="../database/dbservice.html" class="page">DB service</a></li>
  </ul></li>
  <li><a href="../fieldnull/index.html" class="active page">Database null field error</a>
  <ul>
    <li><a href="../fieldnull/code/index.html" class="page">Database define</a></li>
  </ul></li>
  <li><a href="../engagement/index.html" class="page">Engagement entity add to database</a></li>
  <li><a href="../slickqueryfailed/index.html" class="page">Slick query overflow</a></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="../index.html">Doradilla</a></div>

<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>Doradilla
</a>
<div class="version-number">
0.1.0
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../singletruthprinciple.html" class="page">Single truth principle</a></li>
  <li><a href="../database/index.html" class="page">Database Single truth principle</a>
  <ul>
    <li><a href="../database/dbservice.html" class="page">DB service</a></li>
  </ul></li>
  <li><a href="../fieldnull/index.html" class="active page">Database null field error</a>
  <ul>
    <li><a href="../fieldnull/code/index.html" class="page">Database define</a></li>
  </ul></li>
  <li><a href="../engagement/index.html" class="page">Engagement entity add to database</a></li>
  <li><a href="../slickqueryfailed/index.html" class="page">Slick query overflow</a></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<span id="version-warning"></span>

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="../index.html">Doradilla</a></li>
  <li>Database null field error</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#database-null-field-error" name="database-null-field-error" class="anchor"><span class="anchor-link"></span></a>Database null field error</h1>
<h2><a href="#user-bug-report" name="user-bug-report" class="anchor"><span class="anchor-link"></span></a>User bug report</h2>
<p>User report error when they want to define report types for fund in engagemnt:</p>
<p><img src="./userreport.png" alt="User report" /></p>
<p>When check the request in the network:</p>
<p><img src="./requestpayload.png" alt="Request" /></p>
<p>Compare with valid request in network:</p>
<p><img src="./validRequest.png" alt="Valid request" /></p>
<p>We will find that id is missing in the payload.</p>
<h2><a href="#database-check" name="database-check" class="anchor"><span class="anchor-link"></span></a>Database check</h2>
<p>Check the database:</p>
<p><img src="./databasequery.png" alt="Database query" /></p>
<p>It seems the fund_admin_id field is null, we fix this issue, then user could define report types now. But we check the production database, we will find the field will be set to null by application:</p>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/wherby/docs/tree/v0.1.0/docs/src/main/paradox/fieldnull/sql.txt" target="_blank" title="Go to snippet source"></a><code class="language-txt"><br/>4:20:13 PM: mysql&gt; SELECT id,fund_admin_id,fund_admin FROM awm.funds;
+--------------------------------------+---------------+-----------------+
| id                                   | fund_admin_id | fund_admin      |
+--------------------------------------+---------------+-----------------+
| 02635de9-97d8-4520-90f3-68a53e3d6518 | 1             | HSBC IMS        |
| 03361d5c-531e-411f-8a57-e02eaffa81e7 | 1             | HSBC IMS        |


| 8be5db7b-3358-4e3d-a572-839f2f765ed9 | 1             | HSBC IMS        |
| 918bb23a-c5ff-4a91-a822-bf8f8416fadd | 1             | HSBC IMS        |
| 930131cb-9c91-44b0-88e7-12460949dcae | 1             | HSBC IMS        |
| 961c5a46-9a87-4084-ac0d-408c436522d8 | 1             | HSBC IMS        |
| a6e44dc6-b72e-4b23-8d1d-b885c8561e83 | 2             | HSBC MultiFonds |
| b1109ece-7686-4efb-93d6-81e00356c736 | 1             | HSBC IMS        |
| b8c1cb44-c60e-482c-9b7f-67abc6165a75 | 1             | HSBC IMS        |    ********
| be3de937-5c8a-45d7-8619-047a50785430 | 1             | HSBC IMS        |
| cb4c2be3-78b4-4edb-b08f-11b66fb4ee1e | 1             | HSBC IMS        |
| d2bbb0ec-50c1-44b6-8039-686daf8e137f | 1             | HSBC IMS        |
| ebbae85a-52f1-4445-9dbb-79e6d2bd8db1 | 1             | HSBC IMS        |
| f872f26e-21fe-4d12-b23e-baa0635d8ebf | 3             | HSBC Geneva     |
| f9c9eb38-7a1c-43c0-9678-c4562594449b | 1             | HSBC IMS        |
| fb488f25-d2e8-47d2-9090-6807c9960c01 | 1             | HSBC IMS        |
| fbec119f-7e68-4cbc-905b-b40db35f0a2f | 1             | HSBC IMS        |
+--------------------------------------+---------------+-----------------+
43 rows in set (0.00 sec) 



5:38:27 PM: mysql&gt; SELECT id,fund_admin_id,fund_admin FROM awm.funds; 
+--------------------------------------+---------------+-----------------+
| id                                   | fund_admin_id | fund_admin      |
+--------------------------------------+---------------+-----------------+
| 02635de9-97d8-4520-90f3-68a53e3d6518 | 1             | HSBC IMS        |
| 03361d5c-531e-411f-8a57-e02eaffa81e7 | 1             | HSBC IMS        |
| 049d9aa4-2822-4bcd-8ec7-1b6bef3cd628 | 1             | HSBC IMS        |
| 0a1938df-a03a-45c8-8c3a-86e4bd52d92c | 1             | HSBC IMS        |


| 961c5a46-9a87-4084-ac0d-408c436522d8 | 1             | HSBC IMS        |
| a6e44dc6-b72e-4b23-8d1d-b885c8561e83 | 2             | HSBC MultiFonds |
| b1109ece-7686-4efb-93d6-81e00356c736 | 1             | HSBC IMS        |
| b42ab859-ff5a-4fe0-b283-fe0c98c88392 | 1             | HSBC IMS        |
| b8c1cb44-c60e-482c-9b7f-67abc6165a75 | NULL          | HSBC IMS        |   ********
| be3de937-5c8a-45d7-8619-047a50785430 | 1             | HSBC IMS        |
| cb4c2be3-78b4-4edb-b08f-11b66fb4ee1e | 1             | HSBC IMS        |
| d2bbb0ec-50c1-44b6-8039-686daf8e137f | 1             | HSBC IMS        |
| ebbae85a-52f1-4445-9dbb-79e6d2bd8db1 | 1             | HSBC IMS        |
| f872f26e-21fe-4d12-b23e-baa0635d8ebf | 3             | HSBC Geneva     |
| f9c9eb38-7a1c-43c0-9678-c4562594449b | 1             | HSBC IMS        |
| fb488f25-d2e8-47d2-9090-6807c9960c01 | 1             | HSBC IMS        |
| fbec119f-7e68-4cbc-905b-b40db35f0a2f | 1             | HSBC IMS        |
+--------------------------------------+---------------+-----------------+
44 rows in set (0.00 sec) 
</code></pre><h2><a href="#database-define" name="database-define" class="anchor"><span class="anchor-link"></span></a>Database define</h2>
<p>The database define as below:</p>
<dl>
  <dt>Fund</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/wherby/docs/tree/v0.1.0/docs/src/main/paradox/fieldnull/code/fund.sql" target="_blank" title="Go to snippet source"></a><code class="language-sql">create table `funds`(
   `id` varchar(128) NOT NULL,
   `name` VARCHAR(128) not null,
    fund_admin_id varchar(128) null,
   `fund_type` VARCHAR(128) not null,
   `legal_structure` VARCHAR(128) not null,
   `base_currency` VARCHAR(128) not null,
   `audit_period_begin` TIMESTAMP not null,
   `audit_period_end` TIMESTAMP not null,
   `fund_admin` VARCHAR(128) not null,
   `admin_code` VARCHAR(128) NULL,
   `createby` VARCHAR(128) NULL,
   `createdatetime`  TIMESTAMP DEFAULT CURRENT_TIMESTAMP NULL,
   `modifyby` VARCHAR(128) NULL,
   `modifydatetime`  TIMESTAMP  NULL,
   PRIMARY KEY (`id`)
)</code></pre></dd>
  <dt>FundAdmin</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/wherby/docs/tree/v0.1.0/docs/src/main/paradox/fieldnull/code/fundadmin.sql" target="_blank" title="Go to snippet source"></a><code class="language-sql">create table `fund_admin`(
    `id` varchar(128) NOT NULL,
    `name` varchar(128) NOT NULL,
    PRIMARY KEY (`id`)
)</code></pre></dd>
</dl>
<h2><a href="#code-check" name="code-check" class="anchor"><span class="anchor-link"></span></a>Code check</h2>
<p>The field fund_admin_id in fund table is queried from fund admin table.</p>
<dl>
  <dt>Create fund</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/wherby/docs/tree/v0.1.0/docs/src/main/paradox/fieldnull/code/create.scala" target="_blank" title="Go to snippet source"></a><code class="language-scala">override def create(fund: Fund, engagementId:String): Future[Int] = {
  engagementDAO.lookup(engagementId).flatMap(maybeEngagement =&gt; {
    maybeEngagement match {
      case engagement =&gt; {
        fundAdminDAO.queryByFundAdmin(fund.fundAdmin).flatMap(optionFundAdmin =&gt; {
          optionFundAdmin match {
            case Some(fundAdmin) =&gt; {
              fund.fundAdminId = Some(fundAdmin.id)
              fundsDAO.create(fund, engagementId)
            }
            case _ =&gt;{
              throw new Exception(s&quot;fund admin doesn&#39;t exist&quot;)
            }
          }
        }).flatMap(resFund =&gt; {
          var fundEngagement = new FundEngagementData(randomUUID().toString, engagementId, resFund.id, None, resFund.createby, Some(new Timestamp(DateTime.now.getMillis)))
          fundEngagementDAO.create(fundEngagement)
        })
      }
      case _ =&gt; {
        throw new Exception(s&quot;engagement with this Id doesn&#39;t exist&quot;)
      }
    }
  })
}
</code></pre></dd>
  <dt>Update fund</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/wherby/docs/tree/v0.1.0/docs/src/main/paradox/fieldnull/code/update.scala" target="_blank" title="Go to snippet source"></a><code class="language-scala">override def update(fund: Fund): Future[Int] = {
  fundsDAO.lookup(fund.id).flatMap(maybeFund =&gt; {
    maybeFund match {

      //if fundAdmin changed, should update fund admin id and remove fund selection types
      case Some(existingFund) if(existingFund.fundAdmin != fund.fundAdmin) =&gt; {
        fundAdminDAO.queryByFundAdmin(fund.fundAdmin).flatMap(optionFundAdmin =&gt; {
          optionFundAdmin match {
            case Some(fundAdmin) =&gt; {
              fund.fundAdminId = Some(fundAdmin.id)
              fundsDAO.update(fund).flatMap(updateResult =&gt; {
                fundEngagementDAO.queryByFundId(fund.id).flatMap(engagements =&gt; {
                  fundEngagementReportTypeSelectionDAO.deleteByEngagementIds(engagements.map(_.id))
                })
              })
            }
            case _ =&gt;{
              throw new Exception(s&quot;fund admin doesn&#39;t exist&quot;)
            }
          }
        })
      }
      //if fund audit period or accurency changed, should clear uploaded reports and ega.
      case Some(exisitingFund) if(!exisitingFund.auditPeriodBegin.equals(fund.auditPeriodBegin) || !exisitingFund.auditPeriodEnd.equals(fund.auditPeriodEnd) || !exisitingFund.baseCurrency.equals(fund.baseCurrency)) =&gt; {
        fundsDAO.update(fund).flatMap(res =&gt;fundEngagementDAO.queryByFundId(fund.id).flatMap(engagements =&gt;{
          fundEngagementReportTypeSelectionWrite.clearUploadedReports(engagements.map(_.id)).flatMap(result =&gt;{
            egaWrite.cleanEGAByFundEngagementId(engagements.map(_.id))
          })
        }))
      }
      case Some(existingFund) =&gt; {
        fundsDAO.update(fund)
      }
      case _ =&gt; {
        throw new Exception(s&quot;fund  ${fund.name} doesn&#39;t exist&quot;)
      }
    }
  })
}</code></pre></dd>
</dl>
<p>Then we find in update fund, the second branch doesn&rsquo;t retrieve fund_admin_id, so this may lead the null field</p>
<p>So we need to fix the issue by add query:</p>
<dl>
  <dt>Fix one: by add query for second branch
  </dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/wherby/docs/tree/v0.1.0/docs/src/main/paradox/fieldnull/code/updatefix1.scala" target="_blank" title="Go to snippet source"></a><code class="language-scala">override def update(fund: Fund): Future[Int] = {
  fundsDAO.lookup(fund.id).flatMap(maybeFund =&gt; {
    maybeFund match {

      //if fundAdmin changed, should update fund admin id and remove fund selection types
      case Some(existingFund) if(existingFund.fundAdmin != fund.fundAdmin) =&gt; {
        fundAdminDAO.queryByFundAdmin(fund.fundAdmin).flatMap(optionFundAdmin =&gt; {
          optionFundAdmin match {
            case Some(fundAdmin) =&gt; {
              fund.fundAdminId = Some(fundAdmin.id)
              fundsDAO.update(fund).flatMap(updateResult =&gt; {
                fundEngagementDAO.queryByFundId(fund.id).flatMap(engagements =&gt; {
                  fundEngagementReportTypeSelectionDAO.deleteByEngagementIds(engagements.map(_.id))
                })
              })
            }
            case _ =&gt;{
              throw new Exception(s&quot;fund admin doesn&#39;t exist&quot;)
            }
          }
        })
      }
      //if fund audit period or accurency changed, should clear uploaded reports and ega.
      case Some(exisitingFund) if(!exisitingFund.auditPeriodBegin.equals(fund.auditPeriodBegin) || !exisitingFund.auditPeriodEnd.equals(fund.auditPeriodEnd) || !exisitingFund.baseCurrency.equals(fund.baseCurrency)) =&gt; {
        fundAdminDAO.queryByFundAdmin(fund.fundAdmin).flatMap(optionFundAdmin =&gt; {
          optionFundAdmin match {
            case Some(fundAdmin) =&gt; {
              fundsDAO.update(fund).flatMap(res =&gt; fundEngagementDAO.queryByFundId(fund.id).flatMap(engagements =&gt; {
                fundEngagementReportTypeSelectionWrite.clearUploadedReports(engagements.map(_.id)).flatMap(result =&gt; {
                  egaWrite.cleanEGAByFundEngagementId(engagements.map(_.id))
                })
              }))
            }
            case _ =&gt; {
              throw new Exception(s&quot;fund admin doesn&#39;t exist&quot;)
            }
          }
        })
      }
      case Some(existingFund) =&gt; {
        fundsDAO.update(fund)
      }
      case _ =&gt; {
        throw new Exception(s&quot;fund  ${fund.name} doesn&#39;t exist&quot;)
      }
    }
  })
}</code></pre></dd>
  <dt>Fix two: by add shared query
  </dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/wherby/docs/tree/v0.1.0/docs/src/main/paradox/fieldnull/code/updatefix2.scala" target="_blank" title="Go to snippet source"></a><code class="language-scala">override def update(fund: Fund): Future[Int] = {
  val newFundFuture =  fundAdminDAO.queryByFundAdmin(fund.fundAdmin).map{
    tmpOpt =&gt;tmpOpt match{
      case Some(fundAdmin)=&gt;fund.copy(fundAdminId = Some(fundAdmin.id))
      case _=&gt;fund
    }
  }
  val newFund = Await.result(newFundFuture, 1 second)

  fundsDAO.lookup(fund.id).flatMap(maybeFund =&gt; {
    maybeFund match {

      //if fundAdmin changed, should update fund admin id and remove fund selection types
      case Some(existingFund) if(existingFund.fundAdmin != fund.fundAdmin) =&gt; {
        fundsDAO.update(newFund).flatMap(updateResult =&gt; {
          fundEngagementDAO.queryByFundId(fund.id).flatMap(engagements =&gt; {
            fundEngagementReportTypeSelectionDAO.deleteByEngagementIds(engagements.map(_.id))
          })
        })
      }
      //if fund audit period or accurency changed, should clear uploaded reports and ega.
      case Some(exisitingFund) if(!exisitingFund.auditPeriodBegin.equals(fund.auditPeriodBegin) || !exisitingFund.auditPeriodEnd.equals(fund.auditPeriodEnd) || !exisitingFund.baseCurrency.equals(fund.baseCurrency)) =&gt; {
        fundsDAO.update(newFund).flatMap(res =&gt; fundEngagementDAO.queryByFundId(fund.id).flatMap(engagements =&gt; {
          fundEngagementReportTypeSelectionWrite.clearUploadedReports(engagements.map(_.id)).flatMap(result =&gt; {
            egaWrite.cleanEGAByFundEngagementId(engagements.map(_.id))
          })
        }))
      }
      case Some(existingFund) =&gt; {
        fundsDAO.update(newFund)
      }
      case _ =&gt; {
        throw new Exception(s&quot;fund  ${fund.name} doesn&#39;t exist&quot;)
      }
    }
  })
}</code></pre></dd>
</dl>
<h2><a href="#after-fix" name="after-fix" class="anchor"><span class="anchor-link"></span></a>After fix</h2>
<p>Question 1, what&rsquo;s the root cause of the issue?</p>
<ol>
  <li>
  <p>The Fund table contains redundant information of FundAdmin table</p></li>
  <li>
  <p>The update function has multiple paths, and don&rsquo;t use shared function</p></li>
  <li>
  <p>The shared function should in out of update scope.</p></li>
</ol>
<p>Question 2, how to use the single truth principle to resolve issues above? </p>
<div class="source-github">
The source code for this page can be found <a href="https://github.com/wherby/docs/tree/v0.1.0/docs/src/main/paradox/fieldnull/index.md">here</a>.
</div>

<div class="nav-next">
<p><strong>Next:</strong> <a href="../fieldnull/code/index.html">Database define</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="../fieldnull/index.html#database-null-field-error" class="header">Database null field error</a>
  <ul>
    <li><a href="../fieldnull/index.html#user-bug-report" class="header">User bug report</a></li>
    <li><a href="../fieldnull/index.html#database-check" class="header">Database check</a></li>
    <li><a href="../fieldnull/index.html#database-define" class="header">Database define</a></li>
    <li><a href="../fieldnull/index.html#code-check" class="header">Code check</a></li>
    <li><a href="../fieldnull/index.html#after-fix" class="header">After fix</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 2020</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="../lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/magellan.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>
<script type="text/javascript">jQuery(function(jq){initOldVersionWarnings(jq, '0.1.0', '')});</script>


</html>
